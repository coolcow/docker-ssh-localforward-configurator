# This Dockerfile is for running smoke tests on the ssh-localforward-configurator application image.

# The application image to test is passed as a build argument.
# The default value is for local testing.
ARG APP_IMAGE=ghcr.io/coolcow/ssh-localforward-configurator:latest
FROM ${APP_IMAGE}

# Run smoke tests directly inside the application image.
# If any command fails, the build will fail, indicating a problem.
RUN \
    test -x /usr/local/bin/servicesToSshConf.py && \
    python3 --version | grep -q '3.14.3' && \
    /usr/local/bin/servicesToSshConf.py --help >/dev/null && \
    printf '[{"ip":"10.0.0.10","ports":[80,443],"names":["svc-a","svc-a.local"]}]\n' > /tmp/services.json && \
    /usr/local/bin/servicesToSshConf.py \
      /tmp/services.json \
      -n test-target \
      -t ssh.example.org \
      -u test-user \
      -o /tmp/ssh.config > /tmp/hosts.out && \
    grep -q '^Host test-target$' /tmp/ssh.config && \
    grep -q 'Hostname ssh.example.org' /tmp/ssh.config && \
    grep -q 'LocalForward 127.0.1.1:80 10.0.0.10:80' /tmp/ssh.config && \
    grep -q 'LocalForward 127.0.1.1:443 10.0.0.10:443' /tmp/ssh.config && \
    grep -q '^127.0.1.1 10.0.0.10 svc-a svc-a.local$' /tmp/hosts.out
